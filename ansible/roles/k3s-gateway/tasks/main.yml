---
# tasks file for k3s-gateway

- name: Agregar repositoro helm metallb
  ansible.builtin.command: helm repo add metallb https://metallb.github.io/metallb
  changed_when: false
  become: false

- name: Actualizar repositorios helm con metallb
  ansible.builtin.command: helm repo update
  changed_when: false
  become: false

- name: Agregar namespace metallb
  ansible.builtin.shell: kubectl get ns {{ metallb_namespace }} || kubectl create namespace {{ metallb_namespace }}
  changed_when: false

- name: Instalar metallb
  ansible.builtin.shell: |
    helm ls -n {{ metallb_namespace }} | grep metallb || helm install metallb metallb/metallb \
      --namespace {{ metallb_namespace }}
  changed_when: false
  become: false

- name: Esperar 210 secs mientras el servicio metallb inicializa
  ansible.builtin.command: sleep 210
  register: metallb_sleepoutput
  changed_when: metallb_sleepoutput.rc != 0
  failed_when: metallb_sleepoutput.rc != 0

- name: Copia manifiesto de IPAddressPool para metallb
  ansible.builtin.template:
    src: IPAddressPool.yml.j2
    dest: /tmp/IPAddressPool.yml
    owner: root
    group: root
    mode: '0640'

- name: Instala recurso IPAddressPool para metallb
  ansible.builtin.shell: kubectl apply -f /tmp/IPAddressPool.yml
  changed_when: false

- name: Copia manifiesto de L2Advertisement para metallb
  ansible.builtin.template:
    src: L2Advertisement.yml.j2
    dest: /tmp/L2Advertisement.yml
    owner: root
    group: root
    mode: '0640'

- name: Instala recurso L2Advertisement para metallb
  ansible.builtin.shell: kubectl apply -f /tmp/L2Advertisement.yml
  changed_when: false

- name: Incluir tareas de configuración de ingress-nginx
  ansible.builtin.import_tasks: ingress-nginx.yml

- name: Incluir tareas de configuración de external-dns
  ansible.builtin.import_tasks: external-dns.yml

- name: Incluir tareas de configuración de cert-manager
  ansible.builtin.import_tasks: cert-manager.yml
