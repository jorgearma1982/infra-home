---
# tasks file for k3s-gateway

- name: Descargar instalador de helm
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
    dest: /tmp/get-helm.sh
    mode: "0700"

- name: Instalar helm
  ansible.builtin.shell: /tmp/get-helm.sh
  changed_when: false

- name: Limpiar instalador de helm
  ansible.builtin.file:
    path: /tmp/get-helm.sh
    state: absent

- name: Agregar repositoro helm metallb
  ansible.builtin.command: helm repo add metallb https://metallb.github.io/metallb
  changed_when: false

- name: Actualizar repositorios helm con metallb
  ansible.builtin.command: helm repo update
  changed_when: false

- name: Instalar metallb
  ansible.builtin.shell: |
    helm ls -n kube-system | grep metallb || helm install metallb metallb/metallb \
      --namespace kube-system
  changed_when: false

- name: Agregar repositoro helm ingress-nginx
  ansible.builtin.command: helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
  changed_when: false

- name: Actualizar repositorios helm con ingress-nginx
  ansible.builtin.command: helm repo update
  changed_when: false

- name: Agregar namespace ingress
  ansible.builtin.shell: kubectl get ns ingress || kubectl create namespace ingress
  changed_when: false

- name: Instalar el controlador ingress-nginx
  ansible.builtin.shell: |
    helm ls -n ingress | grep ingress || helm install ingress ingress-nginx/ingress-nginx \
      --namespace ingress \
      --set controller.ingressClass={{ ingress_nginx_ingress_class }} \
      --set controller.publishService.enabled={{ ingress_nginx_publish_service_enabled }} \
      --set controller.replicaCount={{ ingress_nginx_replica_count }} \
      --set controller.minAvailable={{ ingress_nginx_min_available }} \
      --set defaultBackend.enabled={{ ingress_nginx_default_backend_enabled }} \
      --set controller.externalTrafficPolicy={{ ingress_nginx_external_traffic_policy }}
  changed_when: false
